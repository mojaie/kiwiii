// https://github.com/mojaie/kiwiii-client Version 0.7.0. Copyright 2017 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("pako"),require("Dexie"),require("vega"),require("jLouvain")):"function"==typeof define&&define.amd?define(["d3","pako","Dexie","vega","jLouvain"],t):e.kwgraph=t(e.d3,e.pako,e.Dexie,e.vega,e.jLouvain)}(this,function(e,t,n,s,l){"use strict";function o(e,t,n){return new Promise((s,l)=>{const o=new FileReader,r=t?e.slice(0,t):e;o.onload=(e=>s(e.target.result)),o.onerror=(e=>l(e)),n?o.readAsArrayBuffer(r):o.readAsText(r)})}function r(e,n){const s=n?t.inflate(e,{to:"string"}):e;return JSON.parse(s)}function a(e,t){try{const n=window.URL.createObjectURL(new Blob([e])),s=document.createElement("a");s.download=t,s.href=n,s.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}function c(e){return ge[e]}function i(e){return ce.getResources().then(t=>t.filter(t=>e.includes(t.domain)))}function u(){const e=c("urlQuery");return e.hasOwnProperty("id")?ce.getItemById(e.id):Promise.resolve()}function d(e,t,n){return ce.updateItem(e,e=>{e[t]=n})}function p(){"serviceWorker"in navigator&&!X?navigator.serviceWorker.register("sw.js").then(e=>{console.info("ServiceWorker registration successful with scope: ",e.scope)}).catch(e=>{console.info("ServiceWorker registration failed: ",e)}):X?console.info("Off-line mode is disabled for debugging"):console.info("Off-line mode is not supported");const e=ve.templates().then(e=>{be.setGlobalConfig("templates",e.templates)}),t=ve.status().then(e=>{be.setGlobalConfig("server",e)}),n=be.fetcherInstances().map(e=>e.getResources()).extendAsync().then(e=>{const t=e.map((e,t)=>(e.idx=t,e));return be.setResources(t)});return Promise.all([e,t,n])}function m(e,t){const n=parseFloat(e),s=parseFloat(t);return isNaN(n)||isNaN(s)?String(t).localeCompare(String(e)):s-n}function h(e,t){return String(t).localeCompare(String(e))}function f(e,t,n){const s=e.select("thead tr").selectAll("th").data(),l=e.select("tbody").selectAll("tr").data(t,n);l.exit().remove();const o=l.enter().append("tr");o.selectAll("td").data(e=>s.map(t=>e[t.key])).enter().append("td"),o.merge(l).selectAll("td").classed("align-middle",!0).html((e,t)=>void 0===e?"":"plot"===s[t].valueType?"[plot]":"image"===s[t].valueType?"[image]":s[t].hasOwnProperty("digit")&&"raw"!==s[t].digit?Ie.formatNum(e,s[t].digit):e)}function g(e){return be.getDataSourceColumns(e.domain,e.dataSource).then(t=>be.getFetcher(e.domain).formatResult(t,e))}function y(e){const t={id:e,column:W.optionData(`#${e}-col`)},n=W.optionData(`#${e}-preset`);if("ordinal"===n.scale.scale)return t.scale=n.scale,t;t.scale={scale:W.value(`#${e}-scaletype`),domain:[W.value(`#${e}-domain-from`),W.value(`#${e}-domain-to`)],unknown:"#696969"};const s=[W.value(`#${e}-range-from`)];return W.checked(`#${e}-range-enable-mid`)&&s.push(W.value(`#${e}-range-mid`)),s.push(W.value(`#${e}-range-to`)),t.scale.range=s,t}function b(){const e=y("label");return e.text=W.value("#label-text"),e.size=W.value("#label-size"),e.visible=W.checked("#label-visible"),e}function v(e){return{id:e,scale:{scale:W.value(`#${e}-scaletype`),domain:[W.value(`#${e}-domain-from`),W.value(`#${e}-domain-to`)],range:[W.value(`#${e}-range-from`),W.value(`#${e}-range-to`)],unknown:10}}}function k(){const e=v("size");return e.column=W.optionData("#size-col"),e}function w(){return{structure:{visible:W.checked("#show-struct")}}}function x(){const e=v("edge");return e.visible=W.checked("#edge-visible"),e.label={size:W.value("#edge-label-size"),visible:W.checked("#edge-label-visible")},e}function I(t){e.selectAll(".node").select(".node-symbol").style("fill",e=>se.scaleFunction(t.scale)(e[t.column.key]))}function C(t){e.selectAll(".node").select(".node-symbol").attr("r",e=>se.scaleFunction(t.scale)(e[t.column.key]))}function A(t){e.selectAll(".node").select(".node-label").attr("visibility",t?"inherit":"hidden")}function q(t){e.selectAll(".node").select(".node-label").text(e=>e.hasOwnProperty(t.text)?t.column.hasOwnProperty("digit")&&"raw"!==t.column.digit?Ie.formatNum(e[t.text],t.column.digit):e[t.text]:"").attr("font-size",t.size).attr("visibility",t.visible?"inherit":"hidden").style("fill",e=>se.scaleFunction(t.scale)(e[t.column.key]))}function P(t){e.selectAll(".node").select(".node-struct").attr("visibility",t.structure.visible?"inherit":"hidden").each((t,n,s)=>{const l=e.select(s[n]).select("svg").attr("width"),o=e.select(s[n]).select("svg").attr("height");e.select(s[n]).attr("transform",`translate(${-l/2},${-o/2})`)})}function R(t){e.selectAll(".link").select(".edge-line").attr("visibility",t?"inherit":"hidden")}function O(t){e.selectAll(".link").select(".edge-label").attr("visibility",t?"inherit":"hidden")}function D(t){e.selectAll(".link").select(".edge-line").style("stroke-width",e=>se.scaleFunction(t.scale)(e.weight)),e.selectAll(".link").select(".edge-label").attr("font-size",t.label.size),R(t.visible),O(t.label.visible)}function $(t,n){2===t.length?(e.select(`#${n}-range-from`).property("value",t[0]),e.select(`#${n}-range-enable-mid`).attr("checked",null),e.select(`#${n}-range-mid`).attr("disabled","disabled"),e.select(`#${n}-range-to`).property("value",t[1]),e.selectAll(`#${n}-range input`).attr("disabled",null)):3===t.length?(e.select(`#${n}-range-from`).property("value",t[0]),e.select(`#${n}-range-enable-mid`).attr("checked","checked"),e.select(`#${n}-range-mid`).property("value",t[1]),e.select(`#${n}-range-to`).property("value",t[2]),e.selectAll(`#${n}-range input`).attr("disabled",null)):e.selectAll(`#${n}-range input`).attr("disabled","disabled")}function S(t,n){e.select(`#${n}-scaletype`).property("value",t.scale);const s=t.hasOwnProperty("domain");e.selectAll(`#${n}-domain input`).attr("disabled",s?null:"disabled"),s&&(e.select(`#${n}-domain-from`).property("value",t.domain[0]),e.select(`#${n}-domain-to`).property("value",t.domain[1])),$(t.range,n)}function T(t){const n=t.id;e.select(`#${n}-visible`).attr("checked",t.visible?"checked":null),e.select(`#${n}-text`).property("value",t.text),e.select(`#${n}-size`).property("value",t.size),t.hasOwnProperty("column")&&e.select(`#${n}-col`).property("value",t.column.key),t.hasOwnProperty("label")&&(e.select(`#${n}-label-visible`).attr("checked",t.label.visible?"checked":null),e.select(`#${n}-label-size`).property("value",t.label.size)),S(t.scale,t.id)}function z(t,n){e.select(`#${n}-col`).call(qe.selectOptions,t,e=>e.key,e=>e.name),e.select(`#${n}-preset`).call(qe.selectOptions,se.colorPresets,e=>e.name,e=>e.name).on("change",function(){S(W.optionData(this).scale,n),e.select(`.${n}-update`).dispatch("change")}),e.select(`#${n}-palette`).call(qe.selectOptions,se.colorPalette,e=>e.name,e=>e.name).on("change",function(){$(W.optionData(this).range,n),e.select(`.${n}-update`).dispatch("change")}),e.select(`#${n}-scaletype`).call(qe.selectOptions,se.scaleTypes,e=>e.name,e=>e.name)}function F(t,n){e.select(`#${n}-preset`).call(qe.selectOptions,t,e=>e.name,e=>e.name).on("change",function(){S(W.optionData(this).scale,n),e.select(`.${n}-update`).dispatch("change")}),e.select(`#${n}-scaletype`).call(qe.selectOptions,se.sizeScaleTypes,e=>e.name,e=>e.name)}function L(){e.selectAll(".node").each(e=>{e.fx=null,e.fy=null}),e.select("#stick-nodes").property("checked",!1),e.select("#graph-contents").selectAll(".link").attr("visibility","hidden"),e.select("#graph-contents").selectAll(".node").call(ze)}function B(){return{nodePositions:e.selectAll(".node").data().map(e=>({x:e.x,y:e.y})),fieldTransform:e.zoomTransform(e.select("#graph-field").node()),nodeContent:e.select("#main-control").datum(),nodeColor:e.select("#color-control").datum(),nodeSize:e.select("#size-control").datum(),nodeLabel:e.select("#label-control").datum(),edge:e.select("#edge-control").datum()}}function E(){const e=be.getGlobalConfig("urlQuery").id;return be.updateTableAttribute(e,"snapshot",B()).then(()=>console.info("Snapshot saved"))}function j(t){if(t.hasOwnProperty("nodeContent")&&(e.select("#main-control").datum(t.nodeContent),e.select("#show-struct").property("checked",!!t.nodeContent.structure.visible)),t.hasOwnProperty("nodeColor")&&(e.select("#color-control").datum(t.nodeColor),$e.updateControl(t.nodeColor)),t.hasOwnProperty("nodeSize")&&(e.select("#size-control").datum(t.nodeSize),$e.updateControl(t.nodeSize)),t.hasOwnProperty("nodeLabel")&&(e.select("#label-control").datum(t.nodeLabel),$e.updateControl(t.nodeLabel)),t.hasOwnProperty("edge")&&(e.select("#edge-control").datum(t.edge),$e.updateControl(t.edge)),t.hasOwnProperty("fieldTransform")){const n=t.fieldTransform,s=e.zoomIdentity.translate(n.x,n.y).scale(n.k);e.select("#graph-contents").attr("transform",s),e.select("#graph-field").call(Le.zoom.transform,s)}t.hasOwnProperty("nodePositions")&&e.selectAll(".node").each((e,n)=>{e.x=t.nodePositions[n].x,e.y=t.nodePositions[n].y}),$e.updateNodeImage(t)}function _(){return be.getCurrentTable().then(e=>be.getTable(e.nodeTableId).then(t=>({edges:e,nodes:t})))}function N(){return _().then(t=>{we.renderStatus(t.edges,V,Q);const n=t.edges.records.filter(e=>e.weight>=t.edges.networkThreshold),s=e.format(".3e")(n.length/t.edges.searchCount);e.select("#edge-density").text(s),e.select("#network-thld").text(t.edges.networkThreshold),Se.graphEdges(e.select("#graph-contents"),n),Se.graphNodes(e.select("#graph-contents"),t.nodes.records),e.select("#show-struct").property("checked",!1),De.setForce(t.nodes.records,n,De.tick,()=>{De.end(),E()}),t.edges.hasOwnProperty("snapshot")?(j(t.edges.snapshot),Le.stickNodes()):Le.restart(),e.select("#graph-contents").style("opacity",1e-6).transition().duration(1e3).style("opacity",1)})}function M(){return _().then(t=>(t.nodes.records.forEach(e=>{delete e._mol}),Re.graphConfigDialog(t.edges,e=>be.updateTableAttribute(t.edges.id,"networkThreshold",e).then(E).then(N)),Re.communityDialog(e=>{const n=t.nodes.records.map(e=>e._index),s=t.edges.records.filter(e=>e.weight>=t.edges.networkThreshold),l=Be.communityDetection(n,s,{nulliso:e.nulliso}),o={key:"_index",column:{key:e.name,name:e.name,sort:"numeric",visible:!0},mapping:l};be.joinColumn(o,t.nodes.id).then(()=>{const t=B();t.nodeColor.column=e.name,t.nodeColor.scale=se.colorPresets.find(e=>"Categories"===e.name).scale;const n=be.getGlobalConfig("urlQuery").id;return be.updateTableAttribute(n,"snapshot",t).then(()=>console.info("snapshot saved"))}).then(M)}),$e.mainControlBox(),$e.nodeColorControlBox(t.nodes.columns),$e.nodeSizeControlBox(t.nodes.columns),$e.nodeLabelControlBox(t.nodes.columns),$e.edgeControlBox(),e.select("#stick-nodes").on("change",function(){!0===W.checked(this)?Le.stickNodes():Le.relax()}),e.select("#nodetable").attr("href",`datatable.html?id=${t.edges.nodeTableId}`),e.select("#rename").on("click",()=>{e.select("#prompt-title").text("Rename table"),e.select("#prompt-label").text("New name"),e.select("#prompt-input").attr("value",t.edges.name),e.select("#prompt-submit").on("click",()=>{const e=W.value("#prompt-input");return be.updateTableAttribute(t.edges.id,"name",e).then(be.getCurrentTable).then(e=>we.renderStatus(e,V,Q))})}),N()))}function U(e){return be.getCurrentTable().then(t=>{if(!le.fetchable(t))return;const n={id:t.id,command:e};return Ee.getRecords(n).then(be.updateTable)})}function V(){return U("update").then(e=>{if(void 0!==e)return N()})}function Q(){return U("abort").then(e=>{if(void 0!==e)return N()})}function G(e){return Promise.all([be.insertTable(e.nodes),be.insertTable(e.edges)]).then(()=>{window.location=`graph.html?id=${e.edges.id}`})}const X=!1;e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,n=n&&n.hasOwnProperty("default")?n.default:n,s=s&&s.hasOwnProperty("default")?s.default:s,l=l&&l.hasOwnProperty("default")?l.default:l;var W={value:function(t){return e.select(t).node().value},valueInt:function(t){return parseInt(e.select(t).node().value)},valueFloat:function(t){return parseFloat(e.select(t).node().value)},checked:function(t){return e.select(t).node().checked},firstFile:function(t){return e.select(t).node().files[0]},checkboxValues:function(t){return e.selectAll(t).selectAll("input:checked").nodes().map(e=>e.value)},optionValues:function(t){return e.selectAll(t).selectAll("select").nodes().map(e=>e.value)},textareaLines:function(t){return e.select(t).node().value.split("\n").filter(e=>e.length>0)},optionData:function(t){const n=e.select(t).property("selectedIndex");return e.select(t).selectAll("option").data().find((e,t)=>t===n)},checkboxData:function(t){return e.selectAll(t).selectAll("input:checked").data()}};const J=e.schemeSet1.concat(e.schemeSet3,e.schemePastel2,e.schemeSet2),H=[20,80],Y=[{name:"Activity",scale:{scale:"log",domain:[1e-4,1e-6],range:["#708090","#7fffd4"],unknown:"#696969"}},{name:"Percent",scale:{scale:"linear",domain:[0,100],range:["#708090","#7fffd4"],unknown:"#696969"}},{name:"True or False",scale:{scale:"quantize",domain:[1,0],range:["#708090","#7fffd4"],unknown:"#696969"}},{name:"LogP",scale:{scale:"linear",domain:[-2,8],range:["#6495ed","#ccff66","#ffa500"],unknown:"#696969"}},{name:"Categories",scale:{scale:"ordinal",range:e.schemeCategory20,unknown:"#dedede"}},{name:"ManyCategories",scale:{scale:"ordinal",range:J,unknown:"#dedede"}}],K=[{name:"Activity",scale:{scale:"log",domain:[1e-4,1e-6],range:H,unknown:H[0]}},{name:"Percent",scale:{scale:"linear",domain:[0,100],range:H,unknown:H[0]}},{name:"True or False",scale:{scale:"quantize",domain:[1,0],range:H,unknown:H[0]}},{name:"LogP",scale:{scale:"linear",domain:[-2,6],range:H,unknown:H[0]}}],Z=[{name:"Universal",scale:{scale:"linear",domain:[.3,1],range:[.5,5],unknown:1}},{name:"Thin",scale:{scale:"linear",domain:[.5,1],range:[.5,3],unknown:1}},{name:"Amplified",scale:{scale:"linear",domain:[.5,1],range:[1,10],unknown:1}}],ee=[{name:"Aquamarine",range:["#778899","#7fffd4"],unknown:"#696969"},{name:"Chartreuse",range:["#778899","#7fff00"],unknown:"#696969"},{name:"Salmon",range:["#778899","#fa8072"],unknown:"#696969"},{name:"Violet",range:["#778899","#ee82ee"],unknown:"#696969"},{name:"blue-red",range:["#87ceeb","#fff5ee","#fa8072"],unknown:"#696969"},{name:"Spectrum",range:["#6495ed","#ccff66","#ffa500"],unknown:"#696969"}],te=[{name:"linear",func:e.scaleLinear()},{name:"log",func:e.scaleLog()},{name:"quantize",func:e.scaleQuantize()},{name:"ordinal",func:e.scaleOrdinal()}],ne=[{name:"linear",func:e.scaleLinear()},{name:"log",func:e.scaleLog()},{name:"quantize",func:e.scaleQuantize()}];var se={colorPresets:Y,sizePresets:K,edgeWidthPresets:Z,colorPalette:ee,scaleTypes:te,sizeScaleTypes:ne,scaleFunction:function(e){let t=te.find(t=>t.name===e.scale).func,n=e.domain;if(3===e.range.length){const t=(parseFloat(e.domain[0])+parseFloat(e.domain[1]))/2;n=[e.domain[0],t,e.domain[1]]}return"ordinal"!==e.scale&&(t=t.domain(n)),t=t.range(e.range),["linear","log"].includes(e.scale)&&(t=t.clamp(!0)),n=>{if(""===n||void 0===n||null===n)return e.unknown;if("ordinal"!==e.scale&&parseFloat(n)!=n)return e.unknown;if("log"===e.scale&&n<=0)return e.unknown;const s=t(n);return void 0===s?e.unknown:s}}},le={fetchable:function(e){return["In progress","Queued","Aborting"].includes(e.status)},abortRequestable:function(e){return["In progress","Queued"].includes(e.status)},conclike:function(e){return e.hasOwnProperty("valueType")&&["AC50","IC50","ED50"].includes(e.valueType)},dataSourceId:function(e,t,n){return[e,t,n].map(e=>e.capitalize()).join("")}},oe={readFile:o,parseJSON:r,loadJSON:function(e){const t=e.name.endsWith(".gz");return o(e,!1,t).then(e=>r(e,t))},fetchJSON:function(e){const t=decodeURIComponent(e),n=t.endsWith(".gz");return fetch(t).then(e=>n?e.arrayBuffer():e.json()).then(e=>r(e,n))},downloadDataFile:a,downloadJSON:function(e,n,s=!0){const l=JSON.stringify(e);a(s?t.gzip(l):l,`${n}.json${s?".gz":""}`)}};const re={app:"key",items:"id, format, responseDate",resources:"idx, id"};let ae=new n("Store");ae.version(1).stores(re);var ce={getAppSetting:function(e){return ae.app.where("key").equals(e).first().then(e=>{if(void 0!==e)return e.value})},putAppSetting:function(e,t){return ae.app.put({key:e,value:t})},getResources:function(){return ae.resources.orderBy("idx").toArray()},putResources:function(e){return ae.resources.bulkPut(e)},getAllItems:function(){return ae.items.orderBy("responseDate").reverse().toArray()},getItemsByFormat:function(e){return ae.items.where("format").equals(e).reverse().sortBy("responseDate")},getItemById:function(e){return ae.items.where("id").equals(e).first()},updateItem:function(e,t){return ae.items.where("id").equals(e).modify(t)},deleteItem:function(e){return ae.items.where("id").equals(e).delete()},putItem:function(e){return ae.items.put(e)},reset:function(){return ae.delete().then(()=>{(ae=new n("Store")).version(1).stores(re)})}};class ie{constructor(){this.baseURL="",this.available=!1}xhrRequest(e,t=null,n={}){return new Promise((s,l)=>{const o=new XMLHttpRequest;o.open("method"in n?n.method:"POST",e),o.responseType="responseType"in n?n.responseType:"json",o.withCredentials="withCredentials"in n&&n.withCredentials,o.onload=(()=>{200!==o.status?l(o):s(o.response)}),o.send(t)})}now(){return(new Date).toString()}getResources(){}formatResult(e,t){return t.lastUpdated=this.now(),t}getRecords(){}getRecordsByCompound(){}getMapping(){}getGraphEdges(){}}class ue extends ie{constructor(){super(),this.baseURL="./",this.domain="activity",this.entities=[]}serializedRequest(e,t={}){const n=new FormData;return n.set("query",JSON.stringify(t)),fetch(`${this.baseURL}${e}`,{method:"post",body:n,credentials:"include"})}request(e,t={}){const n=new FormData;return new Map(Object.entries(t)).forEach((e,t)=>{Array.isArray(e)?e.forEach(e=>n.append(t,e)):n.set(t,e)}),fetch(`${this.baseURL}${e}`,{method:"post",body:n,credentials:"include"})}getResources(){return this.request("schema",{domain:this.domain}).then(e=>e.json()).then(e=>(e.resources.forEach(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.hasOwnProperty("method")||(e.method="sql"),e.visible=!0}),this.entities.push(e.entity)}),this.available=!0,e.resources))}getRecords(e){return this.serializedRequest("sql",e).then(e=>e.json()).then(e=>(e.domain=this.domain,e))}getRecordsByCompound(e){const t={method:"sql",targets:this.entities,key:"ID",values:[e],operator:"eq"};return this.getRecords(t)}getMapping(e,t){const n={method:"sql",targets:[t.entity],key:"ID",values:e,operator:"fm"};return this.serializedRequest("sql",n).then(e=>e.json()).then(e=>{const s={};return e.records.filter(e=>e.hasOwnProperty(t.dataColumn)).forEach(e=>{s[e.ID]=e[t.dataColumn]}),{key:n.key,column:t,mapping:s,lastUpdated:this.now()}})}status(){return this.request("server").then(e=>e.json())}templates(){return this.request("templates").then(e=>e.json())}strprev(e){return this.serializedRequest("strprev",e).then(e=>e.text())}exportExcel(e){return this.request("xlsx",e).then(e=>e.blob())}exportSDFile(e){return this.request("exportsdf",e).then(e=>e.text())}reportPreview(e){return this.request("reportprev",e).then(e=>e.json())}report(e){return this.request("report",e).then(e=>e.blob())}}class de extends ue{constructor(){super(),this.domain="chemical",this.hiddenColumns=["_mw","_mw_wo_sw","_formula","_logp","_nonH"]}formatResult(e,t){return 0===e.length?(t.columns.forEach(e=>{e.visible=!this.hiddenColumns.includes(e.key)}),t):(Array.prototype.push.apply(t.columns,e),t.hasOwnProperty("extraColumns")&&(Array.prototype.push.apply(t.columns,t.extraColumns),delete t.extraColumns),t.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.key===t.query.key?e.visible=!0:e.visible=!this.hiddenColumns.includes(e.key)}),t.lastUpdated=this.now(),t)}getResources(){return this.request("schema",{domain:this.domain}).then(e=>e.json()).then(e=>(e.resources.forEach(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.hasOwnProperty("method")||(e.method="chemsql"),e.visible=!0})}),this.available=!0,e.resources))}getRecords(e){let t;return t=e.hasOwnProperty("command")?"rows":e.hasOwnProperty("nodeTableId")?"graph":["chemsql","sql"].includes(e.method)?"sql":"compute",this.serializedRequest(t,e).then(e=>e.json()).then(e=>(e.domain=this.domain,e))}importSDF(e){return this.request("sdf",e).then(e=>e.json()).then(e=>{e.domain=this.domain,e.columns.forEach(e=>{e.visible=!this.hiddenColumns.includes(e.key)});const t=new Date;return e.lastUpdated=t.toString(),e})}}class pe extends ie{constructor(){super(),this.resourceFile="screener_fitting.yaml",this.domain=null,this.baseURL=null}getResources(){const e=new FormData;return e.set("filename",this.resourceFile),fetch("source",{method:"post",body:e,credentials:"include"}).then(e=>e.json()).then(e=>{if(!e.hasOwnProperty("enabled")||!1!==e.enabled)return this.available=!0,this.domain=e.domain,this.baseURL=e.url,e.resources.map(t=>(t.domain=e.domain,t.entity=`${t.qcsRefId}:${t.layerIndex}`,delete t.qcsRefId,delete t.layerIndex,t.columns.forEach(e=>{e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.visible=!0}),t))})}request(e){return fetch(`${this.baseURL}${e}`,{method:"GET",credentials:"include"}).then(e=>e.json())}requestRecords(e){return this.request(e).then(e=>({records:e.compounds.map(e=>({ID:e.compoundId,qcsRefId:e.qcsRefId,layerIndex:e.layerIndex,drcPlot:e.fitting.drcPlot,AC50:e.fitting.linearAC50,hill:Math.round(100*e.fitting.hillCoefficient)/100}))}))}getRecords(e){const t=`/compounds?qcsRefIds=${e.qcsRefIds.join("%2C")}&layerIndices=${e.layerIndex-1}&fields=compoundId%2Cfitting.drcPlot%2Cfitting.linearAC50%2Cfitting.hillCoefficient`;return this.requestRecords(t)}getRecordsByCompound(e){const t=`/compounds?q=compoundId%3A${e}&fields=compoundId%2CqcsRefId%2ClayerIndex%2Cfitting.drcPlot%2Cfitting.linearAC50%2Cfitting.hillCoefficient`;return this.requestRecords(t)}getMapping(e,t){const n=t.entity.split(":"),s={qcsRefId:n[0],layerIndex:parseInt(n[1])};return this.getRecords(s).then(n=>{const s={};return n.records.filter(t=>e.includes(t.ID)).forEach(e=>{s[e.ID]=e[t.dataColumn]}),{key:"ID",column:t,mapping:s,lastUpdated:this.now()}})}getDrcPlot(e,t,n=-20,s=120){const l=`/${t}?width=180&height=180&title=compoundId&activityRangeMin=${n}&activityRangeMax=${s}`;return this.request(l)}getQcsInfo(e){const t=`/qcSessions?q=${e.map(e=>`qcsRefId:${e}`).join(" OR ")}`;return this.request(t).then(e=>e.qcSessions)}}class me extends pe{constructor(){super(),this.resourceFile="screener_rawvalue.yaml"}getResources(){const e=new FormData;return e.set("filename",this.resourceFile),fetch("source",{method:"post",body:e,credentials:"include"}).then(e=>e.json()).then(e=>{if(!e.hasOwnProperty("enabled")||!1!==e.enabled)return this.available=!0,this.domain=e.domain,this.baseURL=e.url,e.resources.map(t=>(t.domain=e.domain,t.entity=`${t.qcsRefId}:${t.layerIndex}`,delete t.qcsRefId,delete t.layerIndex,t.columns.forEach(e=>{e.key="rawValue",e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("dataColumn")||(e.dataColumn=e.key),e.visible=!0}),t))})}requestRecords(e,t){return this.request(e).then(e=>({records:e.plates.filter(e=>e.wells.hasOwnProperty("compoundIds")).map(e=>e.wells.compoundIds.map((t,n)=>({ID:t,qcsRefId:e.qcsRefId,layerIndex:e.layerIndex,rawValue:e.wells.rawValues[n]})).filter(t)).extend()}))}getRecords(e){const t=`/plates?qcsRefIds=${e.qcsRefIds.join("%2C")}&layerIndices=${e.layerIndex-1}&limit=200&fields=wells.rawValues%2Cwells.compoundIds`;return this.requestRecords(t,e=>null!==e.ID)}getRecordsByCompound(e){const t=`/plates?q=wells.compoundIds%3A${e}&fields=wells.rawValues%2Cwells.compoundIds`;return this.requestRecords(t,t=>t.ID===e)}}class he extends pe{constructor(){super(),this.resourceFile="screener_fitting_stub.yaml"}fittingStub(e){if("string"!=typeof e.qcsRefId)throw`${e.qcsRefId} is not a string`;if("number"!=typeof e.layerIndex)throw`${e.layerIndex} is not a number`;return[{ID:"DB00189",drcPlot:"dummy1",AC50:21e-7,hill:1.1,source:"target1_validation"},{ID:"DB00193",drcPlot:"dummy2",AC50:42e-7,hill:null,source:"target1_validation"},{ID:"DB00203",drcPlot:"dummy3",AC50:1e-5,hill:.9,source:"target1_validation"},{ID:"DB00865",drcPlot:"dummy4",AC50:8.8e-8,hill:2.1,source:"target1_validation"},{ID:"DB01143",drcPlot:"dummy5",AC50:"n.d.",hill:null,source:"target1_validation"},{ID:"DB01240",drcPlot:"dummy6",AC50:null,hill:null,source:"target1_validation"}]}getRecords(e){return Promise.resolve({records:this.fittingStub(e)})}getRecordsByCompound(e){const t=this.fittingStub({qcsRefId:"QCS-YYYY",layerIndex:1}).filter(t=>t.ID===e);return Promise.resolve({records:t})}qcsInfoStub(e){if(!Array.isArray(e))throw`${e} is not a string`;const t=[{layerIndex:0,name:"Activity%"},{layerIndex:1,name:"Background%"},{layerIndex:2,name:"Correction"}];return[{qcsRefId:"QCS-XXX0",name:"hoge",layers:t},{qcsRefId:"QCS-XXX1",name:"fuga",layers:t},{qcsRefId:"QCS-XXX2",name:"piyo",layers:t}]}getQcsInfo(e){return Promise.resolve(this.qcsInfoStub(e))}}class fe extends me{constructor(){super(),this.resourceFile="screener_rawvalue_stub.yaml"}rawValueStub(e){if("string"!=typeof e.qcsRefId)throw`${e.qcsRefId} is not a string`;if("number"!=typeof e.layerIndex)throw`${e.layerIndex} is not a number`;return[{ID:"DB00189",rawValue:12.7,source:"target1_screen"},{ID:"DB00193",rawValue:43.6,source:"target1_screen"},{ID:"DB00203",rawValue:102.6,source:"target1_screen"},{ID:"DB00865",rawValue:-.6,source:"target1_screen"},{ID:"DB01143",rawValue:50,source:"target1_screen"},{ID:"DB01240",rawValue:null,source:"target1_screen"}]}getRecords(e){return Promise.resolve({records:this.rawValueStub(e)})}getRecordsByCompound(e){const t=this.rawValueStub({qcsRefId:"QCS-XXXX",layerIndex:1}).filter(t=>t.ID===e);return Promise.resolve({records:t})}}const ge={onLine:!0,server:{},templates:{},urlQuery:{}};window.location.search.substring(1).split("&").map(e=>e.split("=")).forEach(e=>{ge.urlQuery[e[0]]=e[1]});const ye=new Map(Object.entries({chemical:new de,activity:new ue,screenerrawvalue:new me,screenerfitting:new pe,screenerrawvaluestub:new fe,screenerfittingstub:new he}));var be={getGlobalConfig:c,setGlobalConfig:function(e,t){ge[e]=t},localChemInstance:function(){return ye.get("chemical")},getFetcher:function(e){return ye.get(e)},fetcherInstances:function(){return Array.from(ye.values())},dataFetcherInstances:function(){const e=[];return ye.forEach((t,n)=>{"chemical"!==n&&e.push(t)}),e},dataFetcherDomains:function(){const e=[];return ye.forEach((t,n)=>{"chemical"!==n&&e.push(n)}),e},getResources:i,setResources:function(e){return ce.putResources(e)},getResourceColumns:function(e){return i(e).then(e=>e.map(e=>e.columns.map(t=>(t.domain=e.domain,t.key=le.dataSourceId(e.domain,e.id,t.key),t.entity=e.entity,t.hasOwnProperty("tags")||(t.tags=e.tags),t))).extend())},getDataSourceColumns:function(e,t){return ce.getResources([e]).then(e=>t.map(t=>e.find(e=>e.id===t).columns).extend())},getAllTables:function(){return ce.getAllItems()},getTablesByFormat:function(e){return ce.getItemsByFormat(e)},getTable:function(e){return ce.getItemById(e)},getRecords:function(e){return ce.getItemById(e).then(e=>e.records)},getCurrentTable:u,getCurrentRecords:function(){return u().then(e=>e.records)},setColumnsToShow:function(e){return ce.updateItem(c("urlQuery").id,t=>{t.columns.forEach((t,n)=>{t.visible=e.visibles.includes(t.key),t.sort=e.sorts[n],t.digit=e.digits[n]})})},joinColumn:function(e,t=ge.urlQuery.id){const n=e.hasOwnProperty("column")?e.column:e.columns;return ce.updateItem(t,t=>{t.records.filter(t=>e.mapping.hasOwnProperty(t[e.key])).forEach(t=>{e.hasOwnProperty("column")?t[e.column.key]=e.mapping[t[e.key]]:e.columns.forEach((n,s)=>{t[n.key]=e.mapping[t[e.key]][s]})}),t.columns=t.columns.concat(n).unique("key"),t.lastUpdated=e.lastUpdated})},updateTableAttribute:d,insertTable:function(e){return ce.putItem(e)},updateTable:function(e){return void 0===e?Promise.resolve():"Failure"===e.status?d(e.id,"status","Failure"):ce.updateItem(e.id,t=>{const n={responseDate:e.responseDate,records:e.records,columns:e.columns,recordCount:e.recordCount,searchDoneCount:e.searchDoneCount,execTime:e.execTime,progress:e.progress,status:e.status};e.hasOwnProperty("lastUpdated")&&(n.lastUpdated=e.lastUpdated),Object.assign(t,n)})},deleteTable:function(e){return ce.deleteItem(e)},reset:function(){return ce.reset()}};const ve=be.localChemInstance();var ke={loader:function(){return"file:"===document.location.protocol?(console.info("Off-line mode (local file)"),be.setGlobalConfig("onLine",!1),Promise.resolve()):"onLine"in navigator&&!navigator.onLine?(console.info("Off-line mode (no internet connection)"),be.setGlobalConfig("onLine",!1),Promise.resolve()):fetch(`${ve.baseURL}favicon.ico`).then(()=>(be.setGlobalConfig("onLine",!0),p())).catch(()=>(console.info("Off-line mode (server not responding)"),be.setGlobalConfig("onLine",!1),Promise.resolve()))}},we={renderStatus:function(t,n,s){e.select("#loading-circle").style("display","none"),t.hasOwnProperty("status")||(t.status="Completed"),e.select("title").text(t.name),e.select("#title").text(t.name),e.select("#refresh").text("Aborting"===t.status?"Abort requested":"Refresh").style("display",le.fetchable(t)?"inline-block":"none"),e.select("#abort").style("display",le.abortRequestable(t)?"inline-block":"none");const l={datatable:"entries found",connection:"connections created"}[t.format];e.select("#progress").text(`(${t.status} - ${t.recordCount} ${l} in ${t.execTime} sec.)`),"In progress"===t.status&&e.select("#progress").append("div").append("progress").attr("max",100).attr("value",t.progress).text(`${t.progress}%`),e.select("#refresh").on("click",n),e.select("#abort").on("click",()=>{e.select("#confirm-message").text("Are you sure you want to abort this calculation job?"),e.select("#confirm-submit").classed("btn-primary",!1).classed("btn-warning",!0).on("click",()=>{s()})}),console.info("Query"),console.info(t.query)},initializeWithData:function(){e.select("#new-data").style("display","none"),e.select("#loading-circle").style("display","none")},initialize:function(){e.select("#data-control").style("display","none"),e.select("#nodedata").style("display","none"),e.select("#refresh").style("display","none"),e.select("#abort").style("display","none"),e.select("#loading-circle").style("display","none"),e.select("#status").selectAll("li").style("display","none")}},xe={columnMappingToTable:function(e){const t={key:e.key,name:e.key,sort:"text",visible:!0},n=e.hasOwnProperty("column")?e.column:e.columns;return{columns:[t].concat(n),records:Object.entries(e.mapping).map(t=>{const n={};if(n[e.key]=t[0],e.hasOwnProperty("column"))n[e.column.key]=t[1];else{const s=e.columns.map(e=>e.key);t[1].forEach((e,t)=>{n[s[t]]=e})}return n})}},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),n=t.shift().split(","),s=n.shift(),l={created:(new Date).toString(),columns:[],key:s,mapping:{}},o=[];return n.forEach((e,t)=>{""!==e&&(o.push(t),l.columns.push({key:e,name:e,sort:"text",visible:!0}))}),t.forEach(e=>{const t=e.split(","),n=t.shift();l.mapping[n]=Array(o.length),o.forEach(e=>{l.mapping[n][e]=t[e]})}),l},singleToMultiMapping:function(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,columns:[e.column],key:e.key,mapping:t}}},Ie={formatNum:function(t,n){const s={scientific:".3e",si:".3s",rounded:".3r"};return"raw"===n?t:void 0===t||null===t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(s[n])(t):t},partialMatch:function(e,t){return void 0!==t&&null!==t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},numericAsc:m,numericDesc:function(e,t){return m(t,e)},textAsc:h,textDesc:function(e,t){return h(t,e)}},Ce={getSDFPropList:function(e){const t=/>.*?<(\S+)>/g,n=new Set;let s;for(;null!==(s=t.exec(e));)n.add(s[1]);return Array.from(n)}},Ae={showPlot:function(e,t){new s.View(s.parse(e)).initialize(t).run()},plotThumbnail:function(e){return new s.View(s.parse(e)).toImageURL("png")}},qe={selectOptions:function(e,t,n,s){const l=e.selectAll("option").data(t,n);l.exit().remove(),l.enter().append("option").merge(l).attr("value",n).text(s)},checkboxList:function(e,t,n,s,l){const o=e.selectAll("li").data(t,s);o.exit().remove();const r=o.enter().append("li").attr("class","form-check").append("label");r.append("input"),r.append("span");const a=r.merge(o.select("label")).attr("class","form-check-label");a.select("input").attr("type","checkbox").attr("class","form-check-input").attr("name",n).attr("value",s),a.select("span").text(l)},createTable:function(e,t){e.select("thead").size()||e.append("thead").append("tr"),e.select("tbody").size()||e.append("tbody");const n=t.columns.filter(e=>!e.hasOwnProperty("visible")||!1!==e.visible),s=e.select("thead tr").selectAll("th").data(n,e=>e.key);s.exit().remove(),s.enter().append("th").merge(s).text(e=>e.hasOwnProperty("name")?e.name:e.key)},updateTableRecords:f,appendTableRows:function(e,t,n){const s=e.select("tbody").selectAll("tr").data();Array.prototype.push.apply(s,t),f(e,s,n)},addSort:function(t){t.select("thead tr").selectAll("th").filter(e=>"none"!==e.sort).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",n=>{const s="v"===e.select(`#sort-${n.key}`).text(),l=!n.hasOwnProperty("sort")||"numeric"===n.sort,o=s?l?Ie.numericAsc:Ie.textAsc:l?Ie.numericDesc:Ie.textDesc;t.select("tbody").selectAll("tr").sort((e,t)=>o(e[n.key],t[n.key])),e.select(`#sort-${n.key}`).text(s?"^":"v")})},formatNumbers:function(e){e.select("thead tr").selectAll("th").each((t,n)=>{t.hasOwnProperty("digit")&&"raw"!==t.digit&&e.select("tbody").selectAll("tr").selectAll("td").filter((e,t)=>t===n).text(e=>Ie.formatNum(e,t.digit))})}};const Pe=be.localChemInstance();var Re={pickDialog:function(t,n){e.select("#pick-target").call(qe.selectOptions,t,e=>e.entity,e=>e.name).on("change",function(){const t=W.optionData(this);e.select("#pick-queryarea").text(t.placeholders.ID)}),e.select("#pick-queryarea").text(t[0].placeholders.ID),e.select("#pick-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t={method:"chemsql",targets:[W.value("#pick-target")],key:"ID",values:W.textareaLines("#pick-queryarea"),operator:"fm"};return Pe.getRecords(t).then(g).then(n)})},propDialog:function(t,n){e.select("#prop-targets").call(qe.checkboxList,t,"targets",e=>e.entity,e=>e.name).on("change",function(){const t=W.checkboxData("#prop-targets").map(e=>e.columns).extend().unique("key");e.select("#prop-key").call(qe.selectOptions,t,e=>e.key,e=>e.name)}),e.select("#prop-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t=W.optionData("#prop-key"),s={method:t.method,targets:W.checkboxValues("#prop-targets"),key:t.key,values:W.textareaLines("#prop-queryarea"),operator:W.value("#prop-operator")};return Pe.getRecords(s).then(g).then(n)})},structDialog:function(t,n){e.select("#struct-qsrc").call(qe.selectOptions,t,e=>e.entity,e=>e.name),e.select("#struct-targets").call(qe.checkboxList,t,"targets",e=>e.entity,e=>e.name),e.select("#struct-method").selectAll("option.rd").attr("disabled",!0===be.getGlobalConfig("rdk")?null:"disabled"),e.select("#struct-method").on("change",function(){const t=e.select(this.selectedOptions[0]);e.select("#struct-thldtype").attr("disabled",t.classed("thld")?null:"disabled").property("value",t.classed("edge")?"edge":"sim"),e.select("#struct-thld").attr("disabled",t.classed("thld")?null:"disabled"),e.select("#struct-thldtype option.sim").attr("disabled",t.classed("sim")?null:"disabled"),e.select("#struct-thldtype option.edge").attr("disabled",t.classed("edge")?null:"disabled"),e.select("#struct-options").selectAll(".gls").attr("disabled",t.classed("gls")?null:"disabled"),e.select("#struct-options").selectAll(".fmcs").attr("disabled","rdfmcs"===this.value?null:"disabled"),e.select("#struct-thld").attr("value","edge"===W.value("#struct-thldtype")?15:.7).attr("min","edge"===W.value("#struct-thldtype")?5:0).attr("max","edge"===W.value("#struct-thldtype")?999:1).attr("step","edge"===W.value("#struct-thldtype")?1:.01)}),e.select("#struct-thldtype").on("change",function(){e.select("#struct-thld").attr("value","edge"===this.value?15:.7).attr("min","edge"===this.value?5:0).attr("max","edge"===this.value?999:1).attr("step","edge"===this.value?1:.01)}),e.select("#struct-format").on("change",function(){e.select("#struct-qsrc").attr("disabled","dbid"===this.value?null:"disabled")}),e.select("#struct-preview").on("click",()=>{const t=W.value("#struct-format"),n={format:t,querySource:"dbid"===t?W.value("#struct-qsrc"):null,value:"molfile"===t?W.value("#struct-queryarea"):W.textareaLines("#struct-queryarea")[0]};return Pe.strprev(n).then(t=>e.select("#struct-image").html(t))}),e.select("#struct-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t=e.select(e.select("#struct-method").node().selectedOptions[0]),s=W.value("#struct-format"),l={method:W.value("#struct-method"),targets:W.checkboxValues("#struct-targets"),format:s,querySource:"dbid"===s?W.value("#struct-qsrc"):null,value:"molfile"===s?W.value("#struct-queryarea"):W.textareaLines("#struct-queryarea")[0],thresholdType:W.value("#struct-thldtype"),threshold:W.valueFloat("#struct-thld"),ignoreHs:W.checked("#struct-ignoreh"),diameter:t.classed("gls")?W.valueInt("#struct-diam"):null,maxTreeSize:t.classed("gls")?W.valueInt("#struct-tree"):null,molSizeCutoff:t.classed("gls")?W.valueInt("#struct-skip"):null,timeout:t.classed("rd")?W.valueInt("#struct-timeout"):null};return Pe.getRecords(l).then(g).then(n)})},sdfDialog:function(t){e.select("#sdf-file").on("change",()=>{const t=new FileReader,n=document.getElementById("sdf-file").files[0];t.onload=(t=>{e.select("#sdf-cols").call(qe.checkboxList,Ce.getSDFPropList(t.target.result),"columns",e=>e,e=>e)}),t.readAsText(n.slice(0,104857600))}),e.select("#sdf-selectall").on("change",()=>{e.select("#sdf-cols").selectAll("input").property("checked",W.checked("#sdf-selectall"))}),e.select("#sdf-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const n={contents:W.firstFile("#sdf-file"),query:JSON.stringify({columns:W.checkboxValues("#sdf-cols"),implh:W.checked("#sdf-implh"),recalc:W.checked("#sdf-recalc")})};return Pe.importSDF(n).then(t)})},columnDialog:function(t,n){const s={columns:[{key:"name",sort:"text",visible:!0},{key:"visible",sort:"text",visible:!0},{key:"sort",sort:"text",visible:!0},{key:"digit",sort:"numeric",visible:!0}]};e.select("#column-table thead").remove(),e.select("#column-table tbody").remove(),e.select("#column-table").call(qe.createTable,s).select("tbody").selectAll("tr").data(t.columns).enter().append("tr").each(function(t){e.select(this).selectAll("td").data(e=>s.columns.map(t=>e[t.key])).enter().append("td").each(function(n,s){0===s?e.select(this).text(e=>e):1===s?e.select(this).classed("column-vis-select",!0).append("input").attr("type","checkbox").attr("value",t.key).property("checked",e=>e):2===s?e.select(this).classed("column-sort-select",!0).append("select").call(qe.selectOptions,"none"===n?["none"]:["numeric","text"],null,e=>e).each(function(t){e.select(this).selectAll("option").property("selected",e=>e===t)}):3===s&&(e.select(this).classed("column-digit-select",!0).append("select").call(qe.selectOptions,["raw","rounded","scientific","si"],null,e=>e).each(function(t){e.select(this).selectAll("option").property("selected",e=>e===t)}),"numeric"!==t.sort&&e.select(this).select("select").attr("disabled","disabled"))})}),e.select("#column-table tbody").selectAll("tr").on("change",function(){const t=e.select(this).select(".column-sort-select select").node().value;e.select(this).select(".column-digit-select select").attr("disabled","numeric"===t?null:"disabled")}),e.select("#column-submit").on("click",()=>{const e={visibles:W.checkboxValues(".column-vis-select"),sorts:W.optionValues(".column-sort-select"),digits:W.optionValues(".column-digit-select")};return be.setColumnsToShow(e).then(n)})},joinDialog:function(t,n,s){const l=be.dataFetcherDomains();return document.getElementById("join-search").addEventListener("keypress",e=>{13===e.keyCode&&e.preventDefault()}),be.getResourceColumns(l).then(l=>{const o=t.columns.map(e=>e.key);e.select("#join-keys").call(qe.checkboxList,l.unique("key"),"keys",e=>e.key,e=>e.name).selectAll("li").each(function(t){const n=o.includes(t.key);e.select(this).selectAll("label").select("input").property("checked",n).attr("disabled",n?"disabled":null)}),e.select("#join-search").on("keyup",function(){const t=e=>Ie.partialMatch(W.value(this),e.name);e.select("#join-keys").selectAll("li").style("visibility",e=>t(e)?null:"hidden").style("position",e=>t(e)?null:"absolute")}),e.select("#join-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const t=W.checkboxValues("#join-keys"),r=l.filter(e=>!o.includes(e.key)).filter(e=>t.includes(e.key)).map(e=>{const t=n.map(e=>e.ID);return be.getFetcher(e.domain).getMapping(t,e)});return Promise.all(r).then(e=>{s(e)})})})},importColDialog:function(t,n){e.select("#importcol-file").on("change",()=>{const t=document.getElementById("importcol-file").files[0],n="csv"===t.name.split(".").pop();oe.readFile(t).then(t=>{const s=n?xe.csvToMapping(t):JSON.parse(t),l=xe.columnMappingToTable(s);e.select("#importcol-preview").call(qe.createTable,l).call(qe.updateTableRecords,l.records.slice(0,5),e=>e[l.columns[0].key]),e.select("#importcol-preview").datum(s)})}),e.select("#importcol-submit").on("click",()=>{let t=e.select("#importcol-preview").datum();e.select("#importcol-preview").datum(null);const s=[];if(t.hasOwnProperty("column")&&(t=xe.singleToMultiMapping(t)),t.columns.forEach((e,n)=>{"plot"===e.valueType&&(t.columns[n].valueType="image",s.push(n))}),s.length>0){const e=[];Object.entries(t.mapping).forEach(n=>{s.forEach(s=>{const l=Ae.plotThumbnail(n[1][s]).then(e=>{t.mapping[n[0]][s]=e});e.push(l)})}),Promise.all(e).then(()=>n([t]))}else n([t])})},graphDialog:function(t,n,s){e.select("#graph-measure").selectAll("option.rd").attr("disabled",!0===be.getGlobalConfig("rdk")?null:"disabled"),e.select("#graph-measure").on("change",function(){e.select("#graph-options").selectAll(".gls").attr("disabled","gls"===this.value?null:"disabled"),e.select("#graph-options").selectAll(".fmcs").attr("disabled","rdfmcs"===this.value?null:"disabled")}),e.select("#graph-submit").on("click",()=>{e.select("#loading-circle").style("display","inline");const l=e.select(e.select("#graph-measure").node().selectedOptions[0]),o={measure:W.value("#graph-measure"),indices:[],molecules:[],nodeTableId:t.id,threshold:W.valueFloat("#graph-thld"),ignoreHs:W.checked("#graph-ignoreh"),diameter:"gls"===l.node().value?W.valueInt("#graph-diam"):null,maxTreeSize:"gls"===l.node().value?W.valueInt("#graph-tree"):null,molSizeCutoff:"gls"===l.node().value?W.valueInt("#graph-skip"):null,timeout:l.classed("rd")?W.valueInt("#graph-timeout"):null};return n.forEach(e=>{o.molecules.push(e._mol),o.indices.push(e._index)}),Pe.getRecords(o).then(s)})},graphConfigDialog:function(t,n){e.select("#graphconfig-thld").attr("value",t.networkThreshold).attr("max",1).attr("min",t.query.threshold),e.select("#graphconfig-submit").on("click",()=>{const e=W.valueFloat("#graphconfig-thld");e<t.query.threshold||n(e)})},communityDialog:function(t){e.select("#community-name").attr("value","comm_"),e.select("#community-submit").on("click",()=>{const e={name:W.value("#community-name"),nulliso:W.checked("#community-nulliso")};t(e)})}};const Oe=e.forceSimulation().force("link",e.forceLink().id(e=>e._index).distance(60).strength(1)).force("charge",e.forceManyBody().strength(-600).distanceMin(15).distanceMax(720)).force("collide",e.forceCollide().radius(90)).force("center",e.forceCenter(600,600)).force("x",e.forceX().strength(.002)).force("y",e.forceY().strength(.002)).stop();var De={fieldWidth:1200,fieldHeight:1200,simulation:Oe,setForce:function(e,t,n,s){Oe.nodes(e).force("link").links(t),Oe.on("tick",n).on("end",s)},tick:function(){e.select("#graph-contents").selectAll(".node").attr("transform",e=>`translate(${e.x}, ${e.y})`);const t=Oe.alpha(),n=t<=Oe.alphaMin();e.select("#temperature").classed("progress-success",n).classed("progress-warning",!n).attr("value",n?1:1-t).text(n?1:1-t)},end:function(){e.select("#graph-contents").selectAll(".link").attr("transform",e=>`translate(${e.source.x}, ${e.source.y})`).attr("visibility","visible"),e.select("#graph-contents").selectAll(".edge-line").attr("x1",0).attr("y1",0).attr("x2",e=>e.target.x-e.source.x).attr("y2",e=>e.target.y-e.source.y),e.select("#graph-contents").selectAll(".edge-label").attr("x",e=>(e.target.x-e.source.x)/2).attr("y",e=>(e.target.y-e.source.y)/2)}},$e={updateNodeStructure:P,updateNodeImage:function(e){C(e.nodeSize),I(e.nodeColor),q(e.nodeLabel),P(e.nodeContent)},updateControl:T,mainControlBox:function(){e.select("#show-struct").on("change",function(){const t=w();e.select("#main-control").datum(t),P(t)}).dispatch("change")},nodeColorControlBox:function(t){z(t.filter(e=>"none"!==e.sort),"color"),e.selectAll(".color-update").on("change",()=>{const t=y("color");e.select("#color-control").datum(t),T(t),I(t)}).dispatch("change")},nodeLabelControlBox:function(t){const n=t.filter(e=>"none"!==e.sort);e.select("#label-text").call(qe.selectOptions,n,e=>e.key,e=>e.name),z(n,"label"),e.select("#label-visible").on("change",function(){A(W.checked(this),"label"),e.select(`.label-update`).dispatch("change")}),e.selectAll(".label-update").on("change",()=>{const t=b();e.select("#label-control").datum(t),T(t),q(t)}).dispatch("change")},nodeSizeControlBox:function(t){const n=t.filter(e=>"numeric"===e.sort);e.select(`#size-col`).call(qe.selectOptions,n,e=>e.key,e=>e.name),F(se.sizePresets,"size"),e.selectAll(".size-update").on("change",()=>{const t=k("size");e.select("#size-control").datum(t),T(t),C(t)}).dispatch("change")},edgeControlBox:function(){F(se.edgeWidthPresets,"edge"),e.select("#edge-visible").on("change",function(){R(W.checked(this)),O(W.checked(this)),e.select(`.edge-update`).dispatch("change")}),e.select("#edge-label-visible").on("change",function(){O(W.checked(this)),e.select(`.edge-update`).dispatch("change")}),e.selectAll(".edge-update").on("change",()=>{const t=x("edge");e.select("#edge-control").datum(t),T(t),D(t)}).dispatch("change")}},Se={graphNodes:function(e,t){const n=e.selectAll(".node").data(t,e=>e.key);n.exit().remove();const s=n.enter().append("g").attr("class","node");s.append("circle").attr("class","node-symbol"),s.append("g").attr("class","node-struct"),s.append("text").attr("class","node-label");const l=s.merge(n);l.select(".node-symbol").attr("r",20).style("fill","#6c6"),l.select(".node-struct").attr("visibility","hidden").html(e=>e._structure),l.select(".node-label").attr("visibility","hidden").attr("x",0).attr("y",30).attr("font-size",16).attr("text-anchor","middle")},graphEdges:function(e,t){const n=e.selectAll(".link").data(t,e=>`${e.source}_${e.target}`);n.exit().remove();const s=n.enter().append("g").attr("class","link");s.append("line").attr("class","edge-line"),s.append("text").attr("class","edge-label");const l=s.merge(n);l.select(".edge-line").style("stroke","#999").style("stroke-opacity",.6),l.select(".edge-label").attr("font-size",16).attr("text-anchor","middle").attr("visibility","hidden").text(e=>e.weight)}};const Te=e.zoom().on("zoom",()=>{e.select("#graph-contents").attr("transform",e.event.transform)}),ze=e.drag().on("start",()=>{e.select("#graph-contents").selectAll(".link").attr("visibility","hidden"),e.event.active||De.simulation.alphaTarget(.1).restart()}).on("drag",t=>{t.fx=e.event.x,t.fy=e.event.y}).on("end",t=>{e.event.active||De.simulation.alphaTarget(0),t.fx=null,t.fy=null}),Fe=e.drag().on("drag",function(t){e.select(this).attr("transform",()=>`translate(${e.event.x}, ${e.event.y})`),t.x=e.event.x,t.y=e.event.y;const n=e.select("#graph-contents").selectAll(".link").filter(e=>[e.source.index,e.target.index].includes(this.__data__.index));n.attr("transform",e=>`translate(${e.source.x}, ${e.source.y})`).attr("visibility","visible"),n.select(".edge-line").attr("x1",0).attr("y1",0).attr("x2",e=>e.target.x-e.source.x).attr("y2",e=>e.target.y-e.source.y),n.select(".edge-label").attr("x",e=>(e.target.x-e.source.x)/2).attr("y",e=>(e.target.y-e.source.y)/2)}).on("end",()=>{De.end()});var Le={zoom:Te,dragWithForce:ze,dragNoForce:Fe,stickNodes:function(){De.simulation.alpha(0).stop(),e.selectAll(".node").each(e=>{e.fx=e.x,e.fy=e.y}),De.tick(),De.end(),e.select("#stick-nodes").property("checked",!0),e.select("#graph-contents").selectAll(".link").attr("visibility","visible"),e.select("#graph-contents").selectAll(".node").call(Fe)},unstickNodes:L,relax:function(){L(),De.simulation.alpha(.1).restart()},restart:function(){L(),De.simulation.alpha(1).restart()},fitToScreen:function(){e.select("#graph-field").call(Te.transform,e.zoomIdentity)}},Be={communityDetection:function(e,t,n){const s=l().nodes(e).edges(t)();if(n.nulliso){const e={};Object.entries(s).forEach(t=>{e.hasOwnProperty(t[1])||(e[t[1]]=[]),e[t[1]].push(t[0])}),Object.entries(e).forEach(e=>{1===e[1].length&&(s[e[1][0]]=null)})}return s}};const Ee=be.localChemInstance();return{force:De,control:$e,component:Se,interaction:Le,community:Be,run:function(){if(e.select("#export").on("click",()=>_().then(e=>oe.downloadJSON(e,e.edges.name))),e.select("#graph-field").attr("viewBox",`0 0 ${De.fieldWidth} ${De.fieldHeight}`).call(Le.zoom),e.select("#snapshot").on("click",E),e.select("#restart").on("click",Le.restart),e.select("#import-json").on("click",()=>document.getElementById("select-file").click()),e.select("#select-file").on("change",()=>{const e=document.getElementById("select-file").files[0];oe.loadJSON(e).then(G)}),be.getGlobalConfig("urlQuery").hasOwnProperty("location")){const e=be.getGlobalConfig("urlQuery").location;return oe.fetchJSON(e).then(e=>Promise.all([be.insertTable(e.nodes),be.insertTable(e.edges)]).then(()=>e.edges.id)).then(e=>{window.location=`graph.html?id=${e}`})}return ke.loader().then(()=>be.getGlobalConfig("urlQuery").hasOwnProperty("id")?(we.initializeWithData(),U("update").then(M)):(we.initialize(),Promise.resolve()))}}});
//# sourceMappingURL=kwgraph.js.map
