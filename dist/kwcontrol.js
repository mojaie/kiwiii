// https://github.com/mojaie/kiwiii Version 0.10.0. Copyright 2018 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("Dexie")):"function"==typeof define&&define.amd?define(["d3","Dexie"],t):e.kwcontrol=t(e.d3,e.Dexie)}(this,function(e,t){"use strict";function a(e,t,a){const r=e.select("thead tr").selectAll("th").data(t);r.exit().remove(),r.enter().append("th").text(e=>e.name),a&&e.call(n,a,e=>e.key,function(e){return(t,a)=>{e.forEach(e=>{const n=a[e.key],r=t.append("td").classed("align-middle",!0);void 0!==n&&("d3_format"===e.format?r.text(d.formatNum(n,e.d3_format)):"plot"===e.format?r.text("[plot]"):"image"===e.format?r.text("[image]"):"control"===e.format?r.call(n):r.text(n))})}}(t))}function n(t,a,n,r){const s=t.select("tbody").selectAll("tr").data(a,n);s.exit().remove(),s.enter().append("tr").merge(s).each(function(t){e.select(this).selectAll("td").remove(),e.select(this).call(r,t)})}function r(e,t){e.classed("modal",!0).attr("tabindex",-1).attr("role","dialog").attr("aria-labelledby","").attr("aria-hidden",!0).attr("id",t),e.select(".modal-dialog").remove(),e.append("div").classed("modal-dialog",!0).attr("role","document").append("div").classed("modal-content",!0)}function s(t,a){t.append("td").classed("name",!0).text(a.name),t.append("td").classed("status",!0).text(a.status),t.append("td").classed("size",!0).text(a.records.length);const n=t.append("td").classed("action",!0);n.append("a").call(y.menuButtonLink,null,"Open","primary").attr("href",`${{nodes:"datagrid",edges:"network"}[a.dataType]}.html?id=${a.storeID}`).attr("target","_blank");const r=["running","ready"].includes(a.status);n.append("a").call(y.menuModalLink,null,"Delete","warning","delete-dialog").property("disabled",r).text(r?"Running":"Delete").on("click",()=>{e.select("#delete-dialog").select(".message").text(`Are you sure you want to delete ${a.name} ?`),e.select("#delete-dialog").select(".ok").on("click",()=>u.deleteItem(a.storeID).then(o))})}function o(){m.get("server").then(m.json).catch().then(t=>{if(!t)return;const a=d.defaultFieldProperties([{key:"id",name:"Workflow ID",format:"text"},{key:"size",name:"File size",d3_format:".3s"},{key:"status",name:"Status",format:"text"},{key:"created",name:"Created",format:"date"},{key:"expires",name:"Expires",format:"date"}]);e.select("#contents").select(".calc").call(x.updateHeader,a,t.calc.records);const n=d.defaultFieldProperties([{key:"key",name:"Key",format:"text"},{key:"value",name:"Value",format:"text"}]),r=Object.entries(t).filter(e=>"calc"!==e[0]).map(e=>({key:e[0],value:e[1]}));e.select("#contents").select(".server").call(x.updateHeader,n,r)}),u.getItemsByDataType("nodes").then(t=>{e.select("#contents").select(".dg").call(x.updateContents,t,e=>e.storeID,s)}),u.getItemsByDataType("edges").then(t=>{e.select("#contents").select(".nw").call(x.updateContents,t,e=>e.storeID,s)})}e=e&&e.hasOwnProperty("default")?e.default:e;class l extends Array{unique(e){return this.reduce((t,a)=>(void 0===t.find(t=>t[e]===a[e])&&t.push(a),t),new l)}extend(){return this.reduce((e,t)=>(Array.prototype.push.apply(e,t),e),new l)}extendAsync(){return Promise.all(this).then(e=>e.reduce((e,t)=>(Array.prototype.push.apply(e,t),e),new l))}toArray(){return Array.from(this)}toObject(){const e={};return this.forEach(t=>{e[t[0]]=t[1]}),e}}var d={defaultFieldProperties:function(e){return e.map(e=>(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),e))},sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id"].includes(e)?"text":"none"},formatNum:function(t,a){return void 0===t||null===t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(a)(t):t},partialMatch:function(e,t){return void 0!==t&&null!==t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},URLQuery:function(){return l.from(window.location.search.substring(1).split("&")).map(e=>e.split("=")).toObject()},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}};const c={items:"storeID, dataType, created"};let i=new(t=t&&t.hasOwnProperty("default")?t.default:t)("Store");i.version(1).stores(c);var u={getAllItems:function(){return i.items.orderBy("created").reverse().toArray()},getItemsByDataType:function(e){return i.items.where("dataType").equals(e).reverse().sortBy("created").catch(t=>{console.error(`IDBError: Unexpected dataType: ${e}`,t)})},getItemByID:function(e){return i.items.where("storeID").equals(e).first().catch(t=>{console.error(`IDBError: Unexpected table ID: ${e}`,t)})},deleteItem:function(e){return i.items.where("storeID").equals(e).delete()},putItem:function(e){return e.storeID||(e.storeID=d.uuidv4()),i.items.put(e)},updateItem:function(e,t){return i.items.where("storeID").equals(e).modify(t).catch(e=>{console.error("IDBError: Update failed",e)})},reset:function(){return i.delete().then(()=>{(i=new t("Store")).version(1).stores(c)})}};const p="";var m={get:function(e,t={}){const a=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${p}${e}${a}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},json:function(e){return e.json()},text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${p}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null}},f={fetchProgress:function(e,t="update"){return u.getItemByID(e).then(a=>{if(!a)return Promise.reject(`Store: ${e} is not available`);if(!["ready","running"].includes(a.status))return;const n={id:a.reference.workflow,command:t};return m.get("progress",n).then(m.json).then(t=>"failure"===t.status?u.updateItem(e,e=>{e.status="failure"}):u.updateItem(e,e=>{e.status=t.status,e.progress=t.progress,e.execTime=t.execTime,e.fields=d.defaultFieldProperties(t.fields),e.records=t.records}))})}},y={buttonBox:function(e,t,a,n){e.classed("form-group",!0).classed("mb-1",!0).append("button").classed("btn",!0).classed(`btn-${n}`,!0).classed("btn-sm",!0).attr("id",t).text(a)},menuButton:function(e,t,a,n){e.classed("btn",!0).classed(`btn-${n}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("id",t).text(a)},menuButtonLink:function(e,t,a,n){e.classed("btn",!0).classed(`btn-${n}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("role","button").attr("href","#").attr("id",t).text(a)},menuModalLink:function(e,t,a,n,r){e.classed("btn",!0).classed(`btn-${n}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("role","button").attr("data-toggle","modal").attr("data-target",`#${r}`).attr("id",t).text(a)},dropdownMenuButton:function(e,t,a,n){e.classed("btn-group",!0).classed("mr-1",!0).attr("id",t),e.append("button").classed("btn",!0).classed(`btn-${n}`,!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown").text(a),e.append("div").classed("dropdown-menu",!0)},dropdownMenuItem:function(e,t,a){e.classed("dropdown-item",!0).attr("id",t).text(a)},dropdownMenuModal:function(e,t,a,n){e.classed("dropdown-item",!0).attr("id",t).attr("data-toggle","modal").attr("data-target",`#${n}`).text(a)},dropdownMenuFile:function(t,a,n,r){t.classed("dropdown-item",!0).attr("id",a).text(n).on("click",function(){e.select(this).select("input").node().click()}).append("form").style("display","none").append("input").attr("type","file").attr("accept",r)},dropdownMenuFileValue:function(e){return e.select("input").node().files[0]}},x={render:function(e,t,n,r,s){e.classed("table",!0).classed("table-striped",!0).classed("table-hover",!0).attr("id",t),n&&e.append("caption").text(n),e.append("thead").append("tr"),e.append("tbody"),r&&e.call(a,r,s)},updateHeader:a,updateContents:n},g={confirmDialog:function(t,a,n){const s=t.call(r,a).select(".modal-content");s.append("div").classed("modal-body",!0).append("div").classed("message",!0).text(n);const o=s.append("div").classed("modal-footer",!0);o.append("button").classed("btn",!0).classed("btn-outline-secondary",!0).classed("cancel",!0).attr("type","button").attr("data-dismiss","modal").text("Cancel"),o.append("button").classed("btn",!0).classed("btn-warning",!0).classed("ok",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${a}-submit`).text("OK").on("click",()=>{e.select("#loading-icon").style("display","inline"),t.dispatch("submit")})},submitDialog:function(t,a,n){const s=t.call(r,a).select(".modal-content"),o=s.append("div").classed("modal-header",!0);o.append("h4").classed("modal-title",!0).text(n),o.append("button").attr("type","button").attr("data-dismiss","modal").attr("aria-label","Close").classed("close",!0).append("span").attr("aria-hidden",!0).html("&times;"),s.append("div").classed("modal-body",!0),s.append("div").classed("modal-footer",!0).append("button").classed("btn",!0).classed("btn-primary",!0).classed("submit",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${a}-submit`).text("Submit").on("click",()=>{e.select("#loading-icon").style("display","inline"),t.dispatch("submit")})}};return{run:function(){const t=e.select("#menubar");t.append("a").call(y.menuButtonLink,null,"+ New datagrid","primary").attr("href","datagrid.html").attr("target","_blank"),t.append("a").call(y.menuButtonLink,null,"+ New network","primary").attr("href","network.html").attr("target","_blank"),t.append("a").call(y.menuButtonLink,null,"Refresh all","outline-secondary").on("click",()=>u.getAllItems().then(e=>Promise.all(e.map(e=>f.fetchProgress(e.storeID)))).then(o)),t.append("a").call(y.menuModalLink,null,"Reset local datastore","warning","reset-dialog");const a=d.defaultFieldProperties([{key:"name",name:"Name",format:"text"},{key:"status",name:"Status",format:"text"},{key:"size",name:"Records",d3_format:"d"},{key:"action",name:"Action",format:"control"}]),n=e.select("#contents").append("div").classed("py-4",!0);n.append("h5").text("Datagrids on local storage"),n.append("table").classed("dg",!0).call(x.render,null,null,a);const r=e.select("#contents").append("div").classed("py-4",!0);r.append("h5").text("Networks on local storage"),r.append("table").classed("nw",!0).call(x.render,null,null,a);const s=e.select("#contents").append("div").classed("py-4",!0);s.append("h5").text("Server calculation job"),s.append("table").classed("calc",!0).call(x.render);const l=e.select("#contents").append("div").classed("py-4",!0);return l.append("h5").text("Server status"),l.append("table").classed("server",!0).call(x.render),e.select("#dialogs").append("div").call(g.confirmDialog,"reset-dialog","Are you sure you want to delete all local tables and reset the datastore ?").select(".ok").on("click",()=>u.reset().then(o)),e.select("#dialogs").append("div").call(g.confirmDialog,"delete-dialog",null),document.location.protocol,"onLine"in navigator&&navigator.onLine,console.info("Off-line mode is disabled for debugging"),o()}}});
//# sourceMappingURL=kwcontrol.js.map
